{% extends 'layouts/basee.html' %}

{% block title %} {{ video.title }} - Stream Video {% endblock %}

{% block stylesheets %}
{{ block.super }}
<style>
    /* Video Stream Section */
    .video-stream-section {
        padding: 40px 20px;
        background-color: #f9f9f9;
    }

    .video-stream-section h1 {
        font-size: 36px;
        margin-bottom: 20px;
        text-align: center;
        color: #007bff;
    }

    .video-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }

    .video-container video {
        width: 100%;
        border-radius: 10px;
    }

    .video-details {
        margin-top: 20px;
    }

    .video-details h2 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #333;
    }

    .video-details p {
        font-size: 16px;
        color: #666;
    }

    .back-link {
        display: inline-block;
        margin-top: 20px;
        color: #007bff;
        text-decoration: none;
        font-size: 16px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .messages {
        margin-bottom: 20px;
    }

    .messages .error {
        color: #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    /* Custom Video Player Styles */
    .custom-video-player {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    .custom-video-player video {
        width: 100%;
        border-radius: 10px;
    }

    .controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
    }

    .controls button {
        background: none;
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
    }

    .controls button:hover {
        color: #007bff;
    }

    .progress-bar {
        flex-grow: 1;
        height: 5px;
        background-color: #444;
        margin: 0 10px;
        position: relative;
        cursor: pointer;
    }

    .progress-bar .progress {
        height: 100%;
        background-color: #007bff;
        width: 0;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<!-- Video Stream Section -->
<div class="video-stream-section">
    <div class="container">
        <h1>{{ video.title }}</h1>

        <!-- Debugging: Print video URL and access count -->
        <p>Remaining Views: {{ access.access_count }}</p>

        <!-- Display messages (e.g., no remaining views) -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="{% if message.tags %}{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Check if the user has access to the video -->
        {% if access.access_count > 0 %}
        <div class="video-container">
            <!-- Custom Video Player -->
            <div class="custom-video-player">
                <video id="videoPlayer" controlsList="nodownload">
                    <source src="{{ video.video_file.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="controls">
                    <button id="playPauseBtn">▶️</button>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <button id="fullscreenBtn">⛶</button>
                </div>
            </div>

            <!-- Video Details -->
            <div class="video-details">
                <h2>Video Details</h2>
                <p>{{ video.description }}</p>
            </div>

            <!-- Back to Course Link -->
            <a href="{% url 'course_videos' video.course.id %}" class="back-link">
                &larr; Back to Course
            </a>
        </div>
        {% else %}
        <p style="text-align: center; font-size: 18px; color: #666;">
            You have no remaining views for this video.
        </p>
        {% endif %}
    </div>
</div>

<script>
    // Custom Video Player Script
    const videoPlayer = document.getElementById('videoPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    // Play/Pause Button
    playPauseBtn.addEventListener('click', () => {
        if (videoPlayer.paused) {
            videoPlayer.play();
            playPauseBtn.textContent = '⏸️';
        } else {
            videoPlayer.pause();
            playPauseBtn.textContent = '▶️';
        }
    });

    // Update Progress Bar
    videoPlayer.addEventListener('timeupdate', () => {
        const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
        progress.style.width = `${percent}%`;
    });

    // Seek on Progress Bar Click
    progressBar.addEventListener('click', (e) => {
        const clickTime = (e.offsetX / progressBar.offsetWidth) * videoPlayer.duration;
        videoPlayer.currentTime = clickTime;
    });

    // Fullscreen Button
    fullscreenBtn.addEventListener('click', () => {
        if (videoPlayer.requestFullscreen) {
            videoPlayer.requestFullscreen();
        } else if (videoPlayer.mozRequestFullScreen) { // Firefox
            videoPlayer.mozRequestFullScreen();
        } else if (videoPlayer.webkitRequestFullscreen) { // Chrome, Safari, Opera
            videoPlayer.webkitRequestFullscreen();
        } else if (videoPlayer.msRequestFullscreen) { // IE/Edge
            videoPlayer.msRequestFullscreen();
        }
    });

    // Disable Right-Click and Keyboard Shortcuts
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && (e.keyCode === 83 || e.keyCode === 85 || e.keyCode === 67)) {
            e.preventDefault();
        }
        if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.shiftKey && e.keyCode === 74)) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}